#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€å…³äº TqSdk â€”â€” å¤©å‹¤é‡åŒ–å¼€å‘åŒ…ã€‘

TqSdk æ˜¯ç”±ä¿¡æ˜“ç§‘æŠ€å‘èµ·å¹¶å¼€æºçš„ Python é‡åŒ–äº¤æ˜“æ¡†æ¶ï¼Œä¸“ä¸ºå›½å†…æœŸè´§å¸‚åœºè®¾è®¡ï¼Œ
æ˜¯å›½å†…æœ€ä¸»æµçš„æœŸè´§é‡åŒ–å¼€å‘å·¥å…·ä¹‹ä¸€ã€‚

æ ¸å¿ƒä¼˜åŠ¿ï¼š
  â— æç®€ä»£ç ï¼šå‡ åè¡Œå³å¯æ„å»ºå®Œæ•´ç­–ç•¥ï¼Œå†…ç½® MA/MACD/BOLL/RSI/ATR ç­‰è¿‘ç™¾ä¸ªæŠ€æœ¯æŒ‡æ ‡
  â— å…¨å“ç§å®æ—¶è¡Œæƒ…ï¼šæœŸè´§ã€æœŸæƒã€è‚¡ç¥¨ï¼Œæ¯«ç§’çº§æ¨é€ï¼Œæ•°æ®å…¨åœ¨å†…å­˜ï¼Œé›¶å»¶è¿Ÿ
  â— å…¨æµç¨‹æ”¯æŒï¼šå†å²å›æµ‹ â†’ æ¨¡æ‹Ÿäº¤æ˜“ â†’ å®ç›˜äº¤æ˜“ â†’ è¿è¡Œç›‘æ§ï¼Œä¸€å¥— API å…¨è¦†ç›–
  â— å¹¿æ³›å…¼å®¹ï¼šæ”¯æŒ 90%+ æœŸè´§å…¬å¸ CTP ç›´è¿åŠä¸»æµèµ„ç®¡æŸœå°
  â— Pandas å‹å¥½ï¼šK çº¿ / Tick æ•°æ®ç›´æ¥è¿”å› DataFrameï¼Œä¸ NumPy æ— ç¼é…åˆ

å®˜æ–¹èµ„æºï¼š
  ğŸ“˜ å®˜æ–¹æ–‡æ¡£ï¼šhttps://doc.shinnytech.com/tqsdk/latest/
  ğŸ™ GitHub  ï¼šhttps://github.com/shinnytech/tqsdk-python
  ğŸ§‘â€ğŸ’» è´¦æˆ·æ³¨å†Œï¼šhttps://account.shinnytech.com/
  ğŸ’¬ ç”¨æˆ·ç¤¾åŒºï¼šhttps://www.shinnytech.com/qa/

å®‰è£…ï¼špip install tqsdk -U
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç­–ç•¥28ï¼šOBV èƒ½é‡æ½®è¶‹åŠ¿ç­–ç•¥
===========================

ã€ç­–ç•¥èƒŒæ™¯ä¸åŸç†ã€‘

OBVï¼ˆOn Balance Volumeï¼Œèƒ½é‡æ½®æŒ‡æ ‡ï¼‰æ˜¯ç”±çº¦ç‘Ÿå¤«Â·æ ¼å…°ç»´å°”ï¼ˆJoseph Granvilleï¼‰
äº1963å¹´åœ¨å…¶è‘—ä½œã€Šè‚¡ç¥¨å¸‚åœºåˆ©æ¶¦çš„æ–°æ–¹æ³•ã€‹ä¸­æå‡ºçš„ä¸€ç§é‡ä»·ç»“åˆæŒ‡æ ‡ã€‚
å°½ç®¡è¯ç”Ÿäºè‚¡ç¥¨å¸‚åœºï¼ŒOBV çš„æ ¸å¿ƒé€»è¾‘åŒæ ·é€‚ç”¨äºæœŸè´§å¸‚åœºï¼Œæ˜¯é‡åŒ–äº¤æ˜“ä¸­
æœ€ç»å…¸ã€æœ€å®ç”¨çš„é‡ä»·æŒ‡æ ‡ä¹‹ä¸€ã€‚

OBV çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šæˆäº¤é‡æ˜¯ä»·æ ¼å˜åŠ¨çš„"å…ˆè¡ŒæŒ‡æ ‡"ã€‚å¸‚åœºä¸Šçš„ä¸»åŠ›èµ„é‡‘åœ¨
æ‹‰å‡ä»·æ ¼ä¹‹å‰ï¼Œå¾€å¾€å…ˆé€šè¿‡å¸ç­¹é˜¶æ®µç§¯ç´¯å¤§é‡å¤šå¤´ä»“ä½ï¼Œè¿™ä¸€è¿‡ç¨‹ä¼´éšç€æˆäº¤é‡
çš„æŒç»­æ”¾å¤§ï¼Œä½†ä»·æ ¼å°šæœªæ˜æ˜¾ä¸Šæ¶¨ã€‚é€šè¿‡ OBV å¯¹æˆäº¤é‡çš„ç´¯ç§¯ç»Ÿè®¡ï¼Œå¯ä»¥åœ¨ä»·æ ¼
æ˜æ˜¾å¯åŠ¨ä¹‹å‰ï¼Œæå‰è¯†åˆ«ä¸»åŠ›èµ„é‡‘çš„æµå‘ï¼Œä»è€Œè·å¾—ä¸€å®šçš„é¢†å…ˆä¼˜åŠ¿ã€‚

ã€OBV è®¡ç®—æ–¹å¼ã€‘

OBV çš„è®¡ç®—è§„åˆ™éå¸¸ç®€å•ç›´è§‚ï¼š
  - è‹¥å½“æ—¥æ”¶ç›˜ä»· > å‰æ—¥æ”¶ç›˜ä»·ï¼ˆä¸Šæ¶¨æ—¥ï¼‰ï¼šOBV = å‰æ—¥OBV + å½“æ—¥æˆäº¤é‡
  - è‹¥å½“æ—¥æ”¶ç›˜ä»· < å‰æ—¥æ”¶ç›˜ä»·ï¼ˆä¸‹è·Œæ—¥ï¼‰ï¼šOBV = å‰æ—¥OBV - å½“æ—¥æˆäº¤é‡
  - è‹¥å½“æ—¥æ”¶ç›˜ä»· = å‰æ—¥æ”¶ç›˜ä»·ï¼ˆå¹³ç›˜æ—¥ï¼‰ï¼šOBV = å‰æ—¥OBVï¼ˆä¸å˜ï¼‰

é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒOBV å°†æ¯ä¸€æ ¹ K çº¿çš„æˆäº¤é‡æŒ‰ç…§ä»·æ ¼æ¶¨è·Œæ–¹å‘è¿›è¡Œæ­£è´Ÿç´¯ç§¯ï¼Œ
å¾—åˆ°ä¸€æ¡åæ˜ èµ„é‡‘æµå‘çš„æ›²çº¿ã€‚å½“ OBV æŒç»­ä¸Šå‡æ—¶ï¼Œè¯´æ˜æ¯æ¬¡ä¸Šæ¶¨æ—¥çš„æˆäº¤é‡
å¤§äºä¸‹è·Œæ—¥çš„æˆäº¤é‡ï¼Œèµ„é‡‘å‡€æµå…¥ï¼›åä¹‹åˆ™å‡€æµå‡ºã€‚

ã€ä¿¡å·ç”Ÿæˆé€»è¾‘ã€‘

æœ¬ç­–ç•¥åŸºäº OBV å‡çº¿ç³»ç»Ÿäº§ç”Ÿäº¤æ˜“ä¿¡å·ï¼š
  1. è®¡ç®—åŸå§‹ OBV åºåˆ—
  2. å¯¹ OBV åºåˆ—è®¡ç®—çŸ­æœŸå‡çº¿ï¼ˆé»˜è®¤10å‘¨æœŸï¼‰å’Œé•¿æœŸå‡çº¿ï¼ˆé»˜è®¤30å‘¨æœŸï¼‰
  3. å½“ OBV çŸ­å‡çº¿ä¸Šç©¿é•¿å‡çº¿æ—¶ï¼Œè§†ä¸ºé‡èƒ½å‘å¥½ã€è¶‹åŠ¿å‘ä¸Šï¼Œäº§ç”Ÿåšå¤šä¿¡å·
  4. å½“ OBV çŸ­å‡çº¿ä¸‹ç©¿é•¿å‡çº¿æ—¶ï¼Œè§†ä¸ºé‡èƒ½èµ°å¼±ã€è¶‹åŠ¿å‘ä¸‹ï¼Œäº§ç”Ÿåšç©ºä¿¡å·

æ­¤å¤–ï¼Œç­–ç•¥è¿˜å¼•å…¥ä»·æ ¼å‡çº¿ä½œä¸ºè¾…åŠ©è¿‡æ»¤æ¡ä»¶ï¼š
  - åšå¤šä¿¡å·è¿˜éœ€æ»¡è¶³ï¼šä»·æ ¼ä½äºä»·æ ¼å‡çº¿ï¼ˆMA20ï¼‰ä¸Šæ–¹
  - åšç©ºä¿¡å·è¿˜éœ€æ»¡è¶³ï¼šä»·æ ¼ä½äºä»·æ ¼å‡çº¿ï¼ˆMA20ï¼‰ä¸‹æ–¹

è¿™æ ·å¯ä»¥æœ‰æ•ˆé¿å…åœ¨è¶‹åŠ¿ç›¸åæ–¹å‘ä¸Šé€†åŠ¿äº¤æ˜“ï¼Œæé«˜ä¿¡å·è´¨é‡ã€‚

ã€é€‚ç”¨å“ç§ä¸å‘¨æœŸã€‘

æœ¬ç­–ç•¥é€‚åˆæµåŠ¨æ€§è¾ƒå¥½ã€æˆäº¤é‡æ•°æ®å¯é çš„ä¸»åŠ›åˆçº¦ï¼Œå¦‚ï¼š
  - æ²ªæ·±300è‚¡æŒ‡æœŸè´§ï¼ˆCFFEX.IFï¼‰
  - èºçº¹é’¢æœŸè´§ï¼ˆSHFE.rbï¼‰
  - é“çŸ¿çŸ³æœŸè´§ï¼ˆDCE.iï¼‰
  - è±†ç²•æœŸè´§ï¼ˆDCE.mï¼‰

æ¨èå‘¨æœŸï¼š60åˆ†é’ŸKçº¿æˆ–æ—¥çº¿ï¼Œè¿‡çŸ­çš„å‘¨æœŸï¼ˆå¦‚1åˆ†é’Ÿï¼‰æˆäº¤é‡å™ªéŸ³è¾ƒå¤§ã€‚

ã€ä»“ä½ä¸é£é™©æ§åˆ¶ã€‘

ç­–ç•¥é‡‡ç”¨å›ºå®šæ‰‹æ•°ï¼ˆ1æ‰‹ï¼‰è¿›è¡Œäº¤æ˜“ï¼ŒåŒæ—¶è®¾ç½®ä»¥ä¸‹é£æ§æªæ–½ï¼š
  - æœ€å¤§æŒä»“æ—¶é—´é™åˆ¶ï¼šå•æ¬¡äº¤æ˜“æŒä»“ä¸è¶…è¿‡ max_hold_bars æ ¹Kçº¿ï¼Œé˜²æ­¢é•¿æœŸè¢«å¥—
  - ä¿¡å·åè½¬å¼ºåˆ¶å¹³ä»“ï¼šå½“åå‘ä¿¡å·å‡ºç°æ—¶ï¼Œå…ˆå¹³ä»“å†å¼€ä»“ï¼Œé¿å…é‡å¤æŒä»“
  - æ”¶ç›˜å‰ä¸å¼€ä»“ï¼šä¸´è¿‘æ”¶ç›˜æ—¶ä¸æ–°å¼€ä»“ä½ï¼Œé˜²æ­¢éš”å¤œé£é™©

ã€æ ¼å…°ç»´å°”é‡ä»·å…³ç³»æ³•åˆ™ï¼ˆæ‰©å±•é˜…è¯»ï¼‰ã€‘

æ ¼å…°ç»´å°”è¿˜æ€»ç»“äº†è‘—åçš„"é‡ä»·å…«å¤§æ³•åˆ™"ï¼Œæœ¬ç­–ç•¥çš„åº•å±‚é€»è¾‘ä¸å…¶å¯†åˆ‡ç›¸å…³ï¼š
  1. ä»·å‡é‡å¢ï¼ˆé‡ä»·é…åˆï¼‰ï¼šè¶‹åŠ¿å¥åº·ï¼Œå¯è¿½æ¶¨
  2. ä»·å‡é‡å‡ï¼ˆé‡ä»·èƒŒç¦»ï¼‰ï¼šè¶‹åŠ¿å‡å¼±ï¼Œæ³¨æ„å‡ä»“
  3. ä»·è·Œé‡å‡ï¼ˆé‡ä»·é…åˆï¼‰ï¼šä¸‹è·ŒåŠ¨èƒ½ä¸è¶³ï¼Œå¯ç­‰å¾…åå¼¹
  4. ä»·è·Œé‡å¢ï¼ˆé‡ä»·èƒŒç¦»ï¼‰ï¼šä¸‹è·ŒåŠ é€Ÿï¼Œå¯è¿½ç©º
OBV å‡çº¿ç³»ç»Ÿæ­£æ˜¯è¿™äº›æ³•åˆ™çš„é‡åŒ–å®ç°ã€‚

ã€æ³¨æ„äº‹é¡¹ã€‘

  - OBV æœ¬èº«æ˜¯ç´¯ç§¯é‡ï¼Œå…¶ç»å¯¹å€¼æ„ä¹‰ä¸å¤§ï¼Œé‡è¦çš„æ˜¯å…¶è¶‹åŠ¿å’Œå‡çº¿å…³ç³»
  - åœ¨æˆäº¤é‡å¼‚å¸¸æ”¾å¤§ï¼ˆå¦‚ä¸»åŠ›å¯¹å€’ï¼‰çš„æƒ…å†µä¸‹ï¼ŒOBV å¯èƒ½äº§ç”Ÿè™šå‡ä¿¡å·
  - å»ºè®®ç»“åˆä»·æ ¼ç»“æ„ï¼ˆå¦‚æ”¯æ’‘é˜»åŠ›ä½ï¼‰å…±åŒåˆ¤æ–­ä¿¡å·æœ‰æ•ˆæ€§
  - æœ¬ç­–ç•¥ä¸ºæ¼”ç¤ºç­–ç•¥ï¼Œå®ç›˜å‰è¯·å……åˆ†å›æµ‹éªŒè¯å‚æ•°
"""

from tqsdk import TqApi, TqAuth, TqBacktest, TqSim
from tqsdk.ta import MA
from datetime import date
import numpy as np

# ===== ç­–ç•¥å‚æ•°é…ç½® =====
SYMBOL = "SHFE.rb2601"          # äº¤æ˜“å“ç§ï¼šèºçº¹é’¢ä¸»åŠ›åˆçº¦
KLINE_DURATION = 60 * 60        # Kçº¿å‘¨æœŸï¼š60åˆ†é’Ÿï¼ˆå•ä½ï¼šç§’ï¼‰
OBV_SHORT = 10                  # OBV çŸ­æœŸå‡çº¿å‘¨æœŸ
OBV_LONG = 30                   # OBV é•¿æœŸå‡çº¿å‘¨æœŸ
PRICE_MA = 20                   # ä»·æ ¼è¾…åŠ©å‡çº¿å‘¨æœŸ
TRADE_VOLUME = 1                # æ¯æ¬¡äº¤æ˜“æ‰‹æ•°
MAX_HOLD_BARS = 20              # æœ€å¤§æŒä»“Kçº¿æ•°ï¼ˆè¶…è¿‡åˆ™å¼ºåˆ¶å¹³ä»“ï¼‰


def calc_obv(close_series, volume_series):
    """
    æ‰‹åŠ¨è®¡ç®— OBVï¼ˆèƒ½é‡æ½®ï¼‰åºåˆ—ã€‚

    å‚æ•°ï¼š
      close_series  - æ”¶ç›˜ä»·åºåˆ—ï¼ˆpandas Series æˆ– numpy arrayï¼‰
      volume_series - æˆäº¤é‡åºåˆ—

    è¿”å›ï¼š
      obv_array - OBV ç´¯ç§¯åºåˆ—ï¼ˆnumpy arrayï¼‰

    è®¡ç®—é€»è¾‘ï¼š
      é€Kçº¿éå†ï¼Œæ ¹æ®æ”¶ç›˜ä»·æ¶¨è·Œå¯¹æˆäº¤é‡è¿›è¡Œæ­£è´Ÿç´¯ç§¯ã€‚
      é¦–æ ¹Kçº¿çš„ OBV åˆå§‹åŒ–ä¸ºå½“æ ¹æˆäº¤é‡ã€‚
    """
    n = len(close_series)
    obv = np.zeros(n, dtype=float)
    obv[0] = volume_series.iloc[0] if hasattr(volume_series, 'iloc') else volume_series[0]

    for i in range(1, n):
        c_cur = close_series.iloc[i] if hasattr(close_series, 'iloc') else close_series[i]
        c_pre = close_series.iloc[i - 1] if hasattr(close_series, 'iloc') else close_series[i - 1]
        v_cur = volume_series.iloc[i] if hasattr(volume_series, 'iloc') else volume_series[i]

        if c_cur > c_pre:
            obv[i] = obv[i - 1] + v_cur   # ä¸Šæ¶¨æ—¥ï¼šç´¯åŠ æˆäº¤é‡
        elif c_cur < c_pre:
            obv[i] = obv[i - 1] - v_cur   # ä¸‹è·Œæ—¥ï¼šå‡å»æˆäº¤é‡
        else:
            obv[i] = obv[i - 1]            # å¹³ç›˜æ—¥ï¼šOBV ä¸å˜

    return obv


def moving_average(arr, period):
    """
    è®¡ç®—ç®€å•ç§»åŠ¨å¹³å‡çº¿ï¼ˆSMAï¼‰ã€‚

    å¯¹äºå‰ period-1 ä¸ªæ•°æ®ç‚¹ï¼Œè¿”å› NaNï¼ˆæ•°æ®ä¸è¶³ï¼‰ã€‚
    ä»ç¬¬ period ä¸ªæ•°æ®ç‚¹å¼€å§‹ï¼Œè¿”å›è¿‡å» period ä¸ªå€¼çš„å‡å€¼ã€‚
    """
    result = np.full(len(arr), np.nan)
    for i in range(period - 1, len(arr)):
        result[i] = np.mean(arr[i - period + 1: i + 1])
    return result


def main():
    # ===== åˆå§‹åŒ– TqApi =====
    # å›æµ‹æ¨¡å¼ï¼š2025å¹´å…¨å¹´å†å²æ•°æ®å›æµ‹
    api = TqApi(
        backtest=TqBacktest(
            start_dt=date(2025, 1, 1),
            end_dt=date(2025, 12, 31)
        ),
        auth=TqAuth("YOUR_ACCOUNT", "YOUR_PASSWORD"),
        account=TqSim(init_balance=200000)   # æ¨¡æ‹Ÿè´¦æˆ·ï¼Œåˆå§‹èµ„é‡‘20ä¸‡
    )

    # ===== è®¢é˜…è¡Œæƒ…æ•°æ® =====
    # è·å–60åˆ†é’ŸKçº¿æ•°æ®ï¼Œä¿ç•™è¶³å¤Ÿå†å²æ•°æ®ç”¨äºè®¡ç®—æŒ‡æ ‡
    klines = api.get_kline_serial(SYMBOL, KLINE_DURATION, data_length=500)

    # è®¢é˜…åˆçº¦æŠ¥ä»·ï¼ˆç”¨äºè·å–å®æ—¶ä»·æ ¼å’Œåˆçº¦ä¿¡æ¯ï¼‰
    quote = api.get_quote(SYMBOL)

    # ===== è·å–è´¦æˆ·ä¸æŒä»“å¯¹è±¡ =====
    account = api.get_account()
    position = api.get_position(SYMBOL)

    print(f"[OBV èƒ½é‡æ½®ç­–ç•¥] å¯åŠ¨ï¼Œå“ç§ï¼š{SYMBOL}ï¼ŒKçº¿å‘¨æœŸï¼š60åˆ†é’Ÿ")
    print(f"OBV å‡çº¿å‚æ•°ï¼šçŸ­æœŸ={OBV_SHORT}ï¼Œé•¿æœŸ={OBV_LONG}ï¼Œä»·æ ¼è¾…åŠ©å‡çº¿={PRICE_MA}")

    # ===== çŠ¶æ€å˜é‡ =====
    last_signal = None        # ä¸Šä¸€æ¬¡ä¿¡å·æ–¹å‘ï¼ˆ'long' / 'short' / Noneï¼‰
    hold_bars = 0             # å½“å‰æŒä»“å·²æŒæœ‰çš„Kçº¿æ•°
    last_bar_id = None        # ä¸Šä¸€æ ¹Kçº¿çš„IDï¼ˆç”¨äºåˆ¤æ–­æ–°Kçº¿ï¼‰

    # ===== ä¸»å¾ªç¯ =====
    while True:
        api.wait_update()

        # åˆ¤æ–­æ˜¯å¦æœ‰æ–°çš„Kçº¿å®Œæˆï¼ˆæ¯å½“ä¸€æ ¹Kçº¿æ”¶ç›˜åè§¦å‘ï¼‰
        if not api.is_changing(klines.iloc[-1], "datetime"):
            continue  # è¿˜åœ¨åŒä¸€æ ¹Kçº¿å†…ï¼Œä¸é‡å¤è®¡ç®—

        current_bar_id = klines.iloc[-1]["id"]
        if current_bar_id == last_bar_id:
            continue  # åŒä¸€æ ¹Kçº¿ï¼Œè·³è¿‡
        last_bar_id = current_bar_id

        # ===== è®¡ç®—æŒ‡æ ‡ =====
        n = len(klines)
        if n < OBV_LONG + 5:
            # æ•°æ®ä¸è¶³ï¼Œç­‰å¾…æ›´å¤šå†å²æ•°æ®
            continue

        close = klines["close"]
        volume = klines["volume"]

        # 1. è®¡ç®— OBV åºåˆ—
        obv_arr = calc_obv(close, volume)

        # 2. è®¡ç®— OBV çš„çŸ­æœŸå’Œé•¿æœŸå‡çº¿
        obv_short_arr = moving_average(obv_arr, OBV_SHORT)
        obv_long_arr = moving_average(obv_arr, OBV_LONG)

        # 3. è®¡ç®—ä»·æ ¼è¾…åŠ©å‡çº¿ï¼ˆMA20ï¼‰
        price_ma_arr = moving_average(close.values, PRICE_MA)

        # å–æœ€æ–°ä¸¤æ ¹Kçº¿çš„ OBV å‡çº¿å€¼ï¼Œç”¨äºåˆ¤æ–­é‡‘å‰/æ­»å‰
        obv_s_cur = obv_short_arr[-1]     # å½“å‰çŸ­æœŸ OBV å‡çº¿
        obv_s_pre = obv_short_arr[-2]     # å‰ä¸€æ ¹çŸ­æœŸ OBV å‡çº¿
        obv_l_cur = obv_long_arr[-1]      # å½“å‰é•¿æœŸ OBV å‡çº¿
        obv_l_pre = obv_long_arr[-2]      # å‰ä¸€æ ¹é•¿æœŸ OBV å‡çº¿

        cur_price = close.iloc[-1]        # å½“å‰æ”¶ç›˜ä»·
        price_ma_val = price_ma_arr[-1]   # å½“å‰ä»·æ ¼å‡çº¿å€¼

        # æ£€æŸ¥æ˜¯å¦æœ‰ NaNï¼ˆæ•°æ®ä¸è¶³ï¼‰
        if any(np.isnan(x) for x in [obv_s_cur, obv_s_pre, obv_l_cur, obv_l_pre, price_ma_val]):
            continue

        # ===== ä¿¡å·åˆ¤æ–­ =====
        # åšå¤šä¿¡å·ï¼šOBV çŸ­å‡çº¿ç”±ä¸‹å‘ä¸Šç©¿è¶Šé•¿å‡çº¿ï¼ˆé‡‘å‰ï¼‰+ ä»·æ ¼åœ¨å‡çº¿ä¸Šæ–¹
        bull_signal = (obv_s_pre <= obv_l_pre) and (obv_s_cur > obv_l_cur) and (cur_price > price_ma_val)

        # åšç©ºä¿¡å·ï¼šOBV çŸ­å‡çº¿ç”±ä¸Šå‘ä¸‹ç©¿è¶Šé•¿å‡çº¿ï¼ˆæ­»å‰ï¼‰+ ä»·æ ¼åœ¨å‡çº¿ä¸‹æ–¹
        bear_signal = (obv_s_pre >= obv_l_pre) and (obv_s_cur < obv_l_cur) and (cur_price < price_ma_val)

        # ===== è·å–å½“å‰æŒä»“çŠ¶æ€ =====
        net_pos = position.pos_long - position.pos_short   # å‡€æŒä»“

        # æŒä»“è¶…è¿‡æœ€å¤§æŒä»“Kçº¿æ•°ï¼Œå¼ºåˆ¶å¹³ä»“
        if net_pos != 0:
            hold_bars += 1
            if hold_bars >= MAX_HOLD_BARS:
                print(f"[å¹³ä»“] æŒä»“è¶…è¿‡ {MAX_HOLD_BARS} æ ¹Kçº¿ï¼Œå¼ºåˆ¶å¹³ä»“ï¼Œå½“å‰å‡€æŒä»“={net_pos}")
                if net_pos > 0:
                    # å¹³å¤šä»“
                    api.insert_order(SYMBOL, direction="SELL", offset="CLOSE",
                                     volume=position.pos_long)
                else:
                    # å¹³ç©ºä»“
                    api.insert_order(SYMBOL, direction="BUY", offset="CLOSE",
                                     volume=position.pos_short)
                last_signal = None
                hold_bars = 0
                continue
        else:
            hold_bars = 0  # æ— æŒä»“åˆ™é‡ç½®è®¡æ•°å™¨

        # ===== æ‰§è¡Œäº¤æ˜“ =====
        if bull_signal and last_signal != 'long':
            # åšå¤šä¿¡å·è§¦å‘
            if net_pos < 0:
                # å…ˆå¹³ç©ºä»“
                print(f"[å¹³ç©º] OBVé‡‘å‰ï¼Œå¹³ç©ºä»“ï¼Œä»·æ ¼={cur_price:.1f}")
                api.insert_order(SYMBOL, direction="BUY", offset="CLOSE",
                                 volume=position.pos_short)

            if net_pos <= 0:
                # å¼€å¤šä»“
                print(f"[å¼€å¤š] OBVé‡‘å‰ + ä»·æ ¼åœ¨MA{PRICE_MA}ä¸Šæ–¹ï¼Œ"
                      f"OBVçŸ­çº¿={obv_s_cur:.0f}ï¼ŒOBVé•¿çº¿={obv_l_cur:.0f}ï¼Œ"
                      f"ä»·æ ¼={cur_price:.1f}ï¼Œå‡çº¿={price_ma_val:.1f}")
                api.insert_order(SYMBOL, direction="BUY", offset="OPEN",
                                 volume=TRADE_VOLUME)
                last_signal = 'long'
                hold_bars = 0

        elif bear_signal and last_signal != 'short':
            # åšç©ºä¿¡å·è§¦å‘
            if net_pos > 0:
                # å…ˆå¹³å¤šä»“
                print(f"[å¹³å¤š] OBVæ­»å‰ï¼Œå¹³å¤šä»“ï¼Œä»·æ ¼={cur_price:.1f}")
                api.insert_order(SYMBOL, direction="SELL", offset="CLOSE",
                                 volume=position.pos_long)

            if net_pos >= 0:
                # å¼€ç©ºä»“
                print(f"[å¼€ç©º] OBVæ­»å‰ + ä»·æ ¼åœ¨MA{PRICE_MA}ä¸‹æ–¹ï¼Œ"
                      f"OBVçŸ­çº¿={obv_s_cur:.0f}ï¼ŒOBVé•¿çº¿={obv_l_cur:.0f}ï¼Œ"
                      f"ä»·æ ¼={cur_price:.1f}ï¼Œå‡çº¿={price_ma_val:.1f}")
                api.insert_order(SYMBOL, direction="SELL", offset="OPEN",
                                 volume=TRADE_VOLUME)
                last_signal = 'short'
                hold_bars = 0

        # è¾“å‡ºå½“å‰çŠ¶æ€ï¼ˆæ¯æ ¹Kçº¿ï¼‰
        print(f"[çŠ¶æ€] ä»·æ ¼={cur_price:.1f} | OBVçŸ­={obv_s_cur:.0f} | OBVé•¿={obv_l_cur:.0f} | "
              f"å‡€æŒä»“={net_pos} | æŒä»“Kçº¿={hold_bars} | è´¦æˆ·æƒç›Š={account.balance:.0f}")


if __name__ == "__main__":
    main()
